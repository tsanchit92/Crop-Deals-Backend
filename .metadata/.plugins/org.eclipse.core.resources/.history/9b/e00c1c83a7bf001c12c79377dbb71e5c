package farm.service;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.core.ParameterizedTypeReference;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Service;
import org.springframework.web.reactive.function.client.WebClient;

import farm.model.Crop;
import farm.model.FarmModel;
import farm.model.FarmerModel;
import farm.repository.FarmRepository;
import reactor.core.publisher.Mono;

@Service
public class FarmService {

	@Autowired
	private WebClient.Builder webClientBuilder;
	
	@Autowired
	private WebClient webClient;

	@Autowired
	public FarmRepository farmRepo;

	public boolean register(FarmModel farmModel) {
		farmRepo.save(farmModel);
		return true;
	}

	public List<Crop> getFarmers() {
		List<Crop> response = webClientBuilder.build().get().uri("http://farmer/farmer/getCrops")
				.accept(MediaType.APPLICATION_JSON).retrieve().bodyToMono(new ParameterizedTypeReference<List<Crop>>() {
				}).block();

		return response;
	}

	public void removeDealer(FarmModel farmModel) {
		farmRepo.deleteById(farmModel.getId());
	}

	public boolean editProfile(FarmModel farm) {
		FarmModel farmModel = farmRepo.getById(farm.getId());
		farmModel.setName(farm.getName());
		farmModel.setUserName(farm.getUserName());
		farmModel.setPassword(farm.getPassword());
		farmModel.setEmail(farm.getEmail());
		farmModel.setContact(farm.getContact());
		farmRepo.save(farmModel);

		return true;
	}

	public  Mono<FarmerModel> rateFarmer(FarmerModel farmerModel) {
		
		Mono<FarmerModel> response = webClientBuilder.build()
                .post()
                .uri("http://180.12.10.10:8080/turnover/")
                .contentType(MediaType.APPLICATION_FORM_URLENCODED)
                .accept(MediaType.APPLICATION_JSON )
                .body(Mono.just(farmerModel),FarmerModel.class)
                .retrieve()
                .bodyToMono(FarmerModel.class);
	  return response;
	  
	  }

}
